/*!
  * @luckrya/markdown-it-link-to-card v0.3.3
  * (c) 2022 - 2024 luckrya
  * Released under the MIT License.
  */
Object.defineProperty(exports,"__esModule",{value:!0});var e=require("url"),t=require("child_process"),r=require("fs"),n=require("http"),o=require("https"),i=require("node:fs");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s,c,l=a(e),u=a(t),d=a(r),f=a(n),h=a(o),p=a(i);function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?g(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function y(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function E(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,y(n.key),n)}}function b(e,t,r){return(t=y(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function m(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,i,a,s=[],c=!0,l=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(l)throw o}}return s}}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return w(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}
/*!
  * @luckrya/utility v0.1.0
  * (c) 2022 - 2022 Y.R
  * Released under the MIT License.
  */()}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}(c=s||(s={})).Array="[object Array]",c.Object="[object Object]",c.Function="[object Function]",c.Number="[object Number]",c.String="[object String]",c.Boolean="[object Boolean]",c.Undefined="[object Undefined]",c.Null="[object Null]",c.Error="[object Error]";var x=function(e){return Object.prototype.toString.call(e)===s.String},S=function(e){return Object.prototype.toString.call(e)===s.Function},O="undefined"!=typeof window,T=function(){return"".concat(process.cwd(),"/.linkcardrc")},k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,r=[{key:"setFile",value:function(e){try{var t=e,r=this.readFile();r&&(t=Object.assign(r,t)),p.default.writeFileSync(T(),JSON.stringify(t))}catch(e){}}},{key:"readFile",value:function(){var e;try{var t=p.default.readFileSync(T(),"utf-8"),r=JSON.parse(t);e=function(e){return Object.prototype.toString.call(e)===s.Object}(r)?r:void 0}catch(t){e=void 0}return e}},{key:"has",value:function(e){return!!this.get(e)}},{key:"get",value:function(e){var t=this.readFile();return null==t?void 0:t[e]}},{key:"set",value:function(e,t){this.setFile(b({},e,t))}}],r&&E(t.prototype,r),n&&E(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),N=new k;function j(e){return'style="'.concat(function(e){return Object.entries(e).map((function(e){var t,r=m(e,2),n=r[0],o=r[1];if(n&&o)return"".concat((t=n,t.replace(/\B([A-Z])/g,"-$1").toLowerCase()),": ").concat(o,";")})).filter(Boolean).join(" ")}(e),'"')}var C=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;return{"-webkit-box-orient":"vertical","-webkit-line-clamp":e,lineClamp:e,display:"-webkit-box",overflow:"hidden",textOverflow:"ellipsis"}},R={small:{a:j({color:"unset !important",display:"block",minWidth:"340px",width:"90%"}),container:j({display:"flex",alignItems:"center",padding:"6px 10px 8px 10px",borderRadius:"8px",border:"0.8px solid #dedede"}),img:j({marginRight:"12px",borderRadius:"8px",width:"50px",height:"50px"}),texts:j({}),title:j(v(v({},C(1)),{},{margin:0,opacity:.8,fontSize:"14px",lineHeight:"14px",fontWeight:"bold"})),description:j(v(v({},C(2)),{},{opacity:.6,margin:"4px 0 0 0",fontWeight:400,fontSize:"12px",lineHeight:"12px"}))},large:{a:j({color:"unset !important",display:"block",minWidth:"340px"}),container:j({display:"flex",alignItems:"center",padding:"12px 14px",borderRadius:"8px",border:"1px solid #dedede"}),img:j({marginRight:"12px",borderRadius:"12px",width:"80px",height:"80px"}),texts:j({}),title:j(v(v({},C(2)),{},{margin:0,opacity:.8,fontSize:"16px",lineHeight:"16px",fontWeight:"bold"})),description:j(v(v({},C()),{},{opacity:.6,fontSize:"13px",margin:"2px 0 0 0",lineHeight:"14px"}))}};var D=function(e,t){var r,n,o={rel:'rel="noopener noreferrer"',target:'target="'.concat(t.target,'"'),href:'href="'.concat(t.href,'"'),title:t.showTitle?'title="'.concat(t.linkTitle,'"'):""},i=function(e,r){return x(t.classPrefix)&&t.classPrefix?r:e},a=(r=t.classPrefix,{container:"".concat(r,"__container"),img:"".concat(r,"__img"),texts:"".concat(r,"__texts"),title:"".concat(r,"__texts--title"),description:"".concat(r,"__texts--desc")}),s=(n=t.size,R[n]||R.large);return'<span style="display:block;">\n  <a '.concat(o.rel," ").concat(o.target," ").concat(o.href," ").concat(o.title," ").concat(s.a,">\n    <span ").concat(i(s.container,a.container),'>\n      <img src="').concat(null==e?void 0:e.logo,'" ').concat(i(s.img,a.img),"/>\n\n      <span ").concat(i(s.texts,a.texts),">\n        <span ").concat(i(s.title,a.title),">\n          ").concat(e.title||t.linkTitle||"","\n        </span>\n        <span ").concat(i(s.description,a.description),">\n          ").concat(e.description||"","\n        </span>\n      </span>\n    </span>\n  </a>\n</span>")};function A(e){try{return new URL(e)}catch(e){}}var P="https://resources.whatwg.org/logo-url.svg",q=/[&<>"']/g,L=/(<[A-Za-z]+\s*[^>]*>(.*)<\/[A-Za-z]+>)/,_=/content=["|']([^>]*)["|']/,H=/href=["|']([^>]*)["|']/,I=/(<title\s*[^>]*>(.*)<\/title>)/g,F=function(e){return new RegExp("<".concat(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"meta","\\s[^>]*\\w+=['|\"]([a-zA-Z]|:|\\s)*").concat(e,"['|\"][^>]*\\/?>"))};function z(e){if(e)return e.replace(q,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"}[e]}))}function M(e){var t,r=e.match(F("title"));if(null!=r&&r.length){var n=r[0].match(_);n&&x(n[1])&&(t=n[1])}else{var o=e.match(I);if(null!=o&&o.length){var i=o[0].match(L);i&&x(i[2])&&(t=i[2])}}return z(t)}function U(e){var t,r=e.match(F("description"));if(null!=r&&r.length){var n=r[0].match(_);n&&x(n[1])&&(t=n[1])}return z(t)}function B(e){var t,r=e.match(F("image"));if(null!=r&&r.length){var n=r[0].match(_);n&&x(n[1])&&(t=n[1])}else{var o=e.match(F("icon","link"));if(null!=o&&o.length){var i=o[0].match(H);i&&x(i[1])&&(t=i[1])}}return t}function G(e,t){var r,n,o,i={title:M(e),description:U(e),logo:(r=B(e),r?A(r)?r:"".concat(null===(n=A(t))||void 0===n?void 0:n.origin).concat("/".concat(r).replace(/\/\//g,"/")):P)};return o=i,Object.values(o).filter((function(e){return x(e)})).length?i:null}var J={},X=l.default,V=u.default.spawn,W=d.default;
/**
 * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
 *
 * This can be used with JS designed for browsers to improve reuse of code and
 * allow the use of existing libraries.
 *
 * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
 *
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 */J.XMLHttpRequest=function(){var e,t,r=this,n=f.default,o=h.default,i={},a=!1,s={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},c={},l={},u=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],d=["TRACE","TRACK","CONNECT"],p=!1,g=!1,v={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,this.withCredentials=!1;this.open=function(e,t,r,n,o){if(this.abort(),g=!1,!function(e){return e&&-1===d.indexOf(e)}(e))throw new Error("SecurityError: Request method not allowed");i={method:e,url:t.toString(),async:"boolean"!=typeof r||r,user:n||null,password:o||null},y(this.OPENED)},this.setDisableHeaderCheck=function(e){a=e},this.setRequestHeader=function(e,t){if(this.readyState!==this.OPENED)throw new Error("INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN");if(function(e){return a||e&&-1===u.indexOf(e.toLowerCase())}(e)){if(p)throw new Error("INVALID_STATE_ERR: send flag is true");e=l[e.toLowerCase()]||e,l[e.toLowerCase()]=e,c[e]=c[e]?c[e]+", "+t:t}else console.warn('Refused to set unsafe header "'+e+'"')},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&t&&t.headers&&t.headers[e.toLowerCase()]&&!g?t.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||g)return"";var e="";for(var r in t.headers)"set-cookie"!==r&&"set-cookie2"!==r&&(e+=r+": "+t.headers[r]+"\r\n");return e.substr(0,e.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&l[e.toLowerCase()]?c[l[e.toLowerCase()]]:""},this.send=function(a){if(this.readyState!==this.OPENED)throw new Error("INVALID_STATE_ERR: connection must be opened before send() is called");if(p)throw new Error("INVALID_STATE_ERR: send has already been called");var u,d=!1,f=!1,h=X.parse(i.url);switch(h.protocol){case"https:":d=!0;case"http:":u=h.hostname;break;case"file:":f=!0;break;case void 0:case null:case"":u="localhost";break;default:throw new Error("Protocol not supported.")}if(f){if("GET"!==i.method)throw new Error("XMLHttpRequest: Only GET method is supported");if(i.async)W.readFile(h.pathname,"utf8",(function(e,t){e?r.handleError(e):(r.status=200,r.responseText=t,y(r.DONE))}));else try{this.responseText=W.readFileSync(h.pathname,"utf8"),this.status=200,y(r.DONE)}catch(e){this.handleError(e)}}else{var v=h.port||(d?443:80),E=h.pathname+(h.search?h.search:"");for(var b in s)l[b.toLowerCase()]||(c[b]=s[b]);if(c.Host=u,d&&443===v||80===v||(c.Host+=":"+h.port),i.user){void 0===i.password&&(i.password="");var m=new Buffer(i.user+":"+i.password);c.Authorization="Basic "+m.toString("base64")}"GET"===i.method||"HEAD"===i.method?a=null:a?(c["Content-Length"]=Buffer.isBuffer(a)?a.length:Buffer.byteLength(a),c["Content-Type"]||(c["Content-Type"]="text/plain;charset=UTF-8")):"POST"===i.method&&(c["Content-Length"]=0);var w={host:u,port:v,path:E,method:i.method,headers:c,agent:!1,withCredentials:r.withCredentials};if(g=!1,i.async){var x=d?o.request:n.request;p=!0,r.dispatchEvent("readystatechange");var S=function(e){r.handleError(e)};e=x(w,(function n(o){if(301!==(t=o).statusCode&&302!==t.statusCode&&303!==t.statusCode&&307!==t.statusCode)t.setEncoding("utf8"),y(r.HEADERS_RECEIVED),r.status=t.statusCode,t.on("data",(function(e){e&&(r.responseText+=e),p&&y(r.LOADING)})),t.on("end",(function(){p&&(y(r.DONE),p=!1)})),t.on("error",(function(e){r.handleError(e)}));else{i.url=t.headers.location;var a=X.parse(i.url);u=a.hostname;var s={hostname:a.hostname,port:a.port,path:a.path,method:303===t.statusCode?"GET":i.method,headers:c,withCredentials:r.withCredentials};(e=x(s,n).on("error",S)).end()}})).on("error",S),a&&e.write(a),e.end(),r.dispatchEvent("loadstart")}else{var O=".node-xmlhttprequest-content-"+process.pid,T=".node-xmlhttprequest-sync-"+process.pid;W.writeFileSync(T,"","utf8");for(var k="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(d?"s":"")+".request;var options = "+JSON.stringify(w)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {  responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+O+"', JSON.stringify({err: null, data: {statusCode: response.statusCode, headers: response.headers, text: responseText}}), 'utf8');fs.unlinkSync('"+T+"');});response.on('error', function(error) {fs.writeFileSync('"+O+"', JSON.stringify({err: error}), 'utf8');fs.unlinkSync('"+T+"');});}).on('error', function(error) {fs.writeFileSync('"+O+"', JSON.stringify({err: error}), 'utf8');fs.unlinkSync('"+T+"');});"+(a?"req.write('"+JSON.stringify(a).slice(1,-1).replace(/'/g,"\\'")+"');":"")+"req.end();",N=V(process.argv[0],["-e",k]);W.existsSync(T););var j=JSON.parse(W.readFileSync(O,"utf8"));N.stdin.end(),W.unlinkSync(O),j.err?r.handleError(j.err):(t=j.data,r.status=j.data.statusCode,r.responseText=j.data.text,y(r.DONE))}}},this.handleError=function(e){this.status=0,this.statusText=e,this.responseText=e.stack,g=!0,y(this.DONE),this.dispatchEvent("error")},this.abort=function(){e&&(e.abort(),e=null),c=s,this.status=0,this.responseText="",this.responseXML="",g=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!p||this.readyState===this.DONE||(p=!1,y(this.DONE)),this.readyState=this.UNSENT,this.dispatchEvent("abort")},this.addEventListener=function(e,t){e in v||(v[e]=[]),v[e].push(t)},this.removeEventListener=function(e,t){e in v&&(v[e]=v[e].filter((function(e){return e!==t})))},this.dispatchEvent=function(e){if("function"==typeof r["on"+e]&&r["on"+e](),e in v)for(var t=0,n=v[e].length;t<n;t++)v[e][t].call(r)};var y=function(e){e!=r.LOADING&&r.readyState===e||(r.readyState=e,(i.async||r.readyState<r.OPENED||r.readyState===r.DONE)&&r.dispatchEvent("readystatechange"),r.readyState!==r.DONE||g||(r.dispatchEvent("load"),r.dispatchEvent("loadend")))}};var Z=new Map,$=O?window.XMLHttpRequest:J.XMLHttpRequest;function K(e){if(Z.has(e))return Z.get(e);var t;try{var r=new $;r.open("GET",e,!1),r.setRequestHeader("Content-Type","text/html"),r.send(),200===r.status&&r.responseText&&(t=r.responseText,Z.set(e,r.responseText))}catch(e){console.error("【XHR Error】：".concat(e instanceof Error?e.message:"get remote URL resource exception!"))}return t}var Q=new Map;exports.generateCard=function(e,t){return new Promise((function(r,n){var o=K(e);if(o){var i=G(o,e);if(i){var a={linkTitle:t.linkTitle,target:t.target||"_blank",size:t.size||"large",showTitle:t.showTitle||!0,classPrefix:t.classPrefix},s=D(i,v(v({},a),{},{href:e})),c={url:e,data:i,options:a,dom:s};Q.set(e,c),r(c)}}}))},exports.linkToCardPlugin=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};function r(e){var r,n=function(e){if(N.has(e))return N.get(e);var t=null,r=K(e);return r&&(t=G(r,e))&&N.set(e,t),t}(e.url);if(n){!function(e,t){e.forEach((function(e,r){r!==t&&(e.hidden=!0)}))}(e.tokens,e.i);var o={href:e.url,linkTitle:(r=e.tokens,r.map((function(e){var t=e.hidden,r=e.content;return t?r:""})).filter(Boolean).join("")),target:t.target||"_blank",size:t.size||"large",showTitle:t.showTitle||!0,classPrefix:t.classPrefix};return S(t.render)?t.render(n,o):D(n,o)}}e.renderer.renderInline=function(t,r,n){for(var o="",i=0;i<t.length;i++){var a=t[i],s=e.renderer.rules[a.type];a.hidden?o+="":S(s)?o+=s(t,i,r,n,e.renderer):o+=e.renderer.renderToken(t,i,r)}return o},e.renderer.rules.link_open=function(e,n,o,i,a){var s,c=e[n],l="a"===c.tag&&"link_open"===c.type,u=function(e){var r=new RegExp("^(".concat((null==t?void 0:t.tag)||"@",":)([a-zA-Z0-9]+.*)")),n=null==e?void 0:e.match(r);return{isCardLink:!!n,url:null==n?void 0:n[2]}}(null===(s=c.attrs)||void 0===s||null===(s=s.filter((function(e){return e.includes("href")}))[0])||void 0===s?void 0:s[1]),d=u.url,f=u.isCardLink;if(l&&f&&d){var h=r({url:d,tokens:e,i:n});return h||a.renderToken(e,n,o)}return a.renderToken(e,n,o)}};
